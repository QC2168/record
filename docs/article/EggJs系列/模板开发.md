---
title: æ¨¡æ¿å¼€å‘
tags: [eggjs]
---

## EggStarter Repo

æ¨¡æ¿åœ°å€: https://github.com/QC2168/egg-starter

ç›®å‰æ¨¡æ¿å·²ç»é›†æˆäº†ä»¥ä¸‹åŠŸèƒ½

- [x] ğŸ› ï¸ ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- [x] ğŸ”’ JWTéªŒè¯æ¨¡å—
- [x] ğŸ§° é›†æˆå¸¸ç”¨å·¥å…·å‡½æ•°
- [x] ğŸ”„ æ›´å¥½çš„è·¯ç”±ç®¡ç†
- [x] ğŸš€ åŸºäºEggJså¿«é€Ÿæ„å»ºRestful Api
- [x] ğŸŒ çº¯Javascript
- [x] ğŸ³ Sequelize Mysql
- [x] ğŸ­ æ”¯æŒ DB Migration / Model Sync
- [x] ğŸ“‚ åŸºäºæ–‡ä»¶ç³»ç»Ÿç¼“å­˜æœåŠ¡
- [x] ğŸ“š é›†æˆSwaggaræ–‡æ¡£
- [x] ğŸ¦„ é›†æˆVscodeä»£ç ç‰‡æ®µ
- [x] ğŸ”§ ESlint
- [x] ğŸ’ª è¿™äº›è¿˜ä¸å¤Ÿï¼Ÿ æ¬¢è¿æ‚¨æ¥æ`Issues / PR`

## åˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ä½œä¸ºæ¨¡æ¿

è¿™é‡Œå’Œä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯é€šè¿‡`egg.js`æä¾›çš„è„šæ‰‹æ¶å·¥å…·ï¼Œåˆ›å»ºä¸€ä¸ª`simple`çš„æ¨¡æ¿

è¿™é‡Œï¼Œæˆ‘ä»¬è¦å…ˆç¡®å®šä»¥ä¸‹ï¼Œæˆ‘ä»¬çš„æ¨¡æ¿éœ€è¦ä½¿ç”¨å“ªäº›è§„èŒƒï¼Œè¿™é‡Œæˆ‘åˆ—åœ¨ä¸‹æ–¹

- `RestfulApi`è¯·æ±‚è§„èŒƒ
- `Api`ç‰ˆæœ¬æ§åˆ¶
- é‡‡ç”¨`Http`çŠ¶æ€ç ä¼ é€’å¤„ç†ç»“æœ
- æ•°æ®è¿”å›ç»“æ„é‡‡ç”¨[`JSONApi`](https://jsonapi.org/)è§„èŒƒ
- æ”¯æŒ`Swagger`æ–‡æ¡£

> è¿™ä¸ªæ¨¡æ¿ä¸é‡‡ç”¨Typescriptè¯­è¨€ï¼Œå› ä¸ºEggç›¸å…³æ’ä»¶å·²ç»æä¾›äº†Index.d.tsæ–‡ä»¶æ”¯æŒï¼Œæ›´å‹å¥½å±æ€§æç¤º
>
> å¦‚æœæ‚¨æƒ³ä½¿ç”¨Typescriptç¼–å†™ï¼Œè¯·é˜…è¯»`https://www.eggjs.org/zh-CN/tutorials/typescript`

## è¯·æ±‚å‚æ•°æ ¡éªŒ

### ç®€å•æ•°æ®æ ¡éªŒ

å¾—ç›Šäº`Egg.js`å¼ºå¤§çš„æ’ä»¶ç”Ÿæ€ï¼Œæˆ‘ä»¬ä¸ç”¨å†ä¸ºè¿™ä¸ªåŠŸèƒ½é€ è½®å­ï¼Œå¯ä»¥ç›´æ¥æ‹¿ç°æˆçš„æ’ä»¶è¿›è¡Œé›†æˆ

```
npm i egg-validate
```

åœ¨`config/plugin.js`ä¸­é…ç½®å®ƒ

```javascript
// config/plugin.js
exports.validate = {
  enable: true,
  package: 'egg-validate',
};
```

æ¥ä¸‹æ¥ï¼Œå¦‚æœæ‚¨æƒ³è¦ä½¿ç”¨å®ƒï¼Œåªæƒ³è¦åœ¨`controller`ä¸­è°ƒç”¨`ctx.validate`å³å¯

```JavaScript
// app/controller/home.js
const Controller = require('egg').Controller;
class HomeController extends Controller {
  async index() {
    const { ctx } = this;
    ctx.validate({ id: 'id' });
  }
}

```
å¦‚æœæ ¡éªŒæœ‰è¯¯ï¼Œå®ƒä¼šç›´æ¥è¿”å›`422`çš„`http`çŠ¶æ€ç å’Œå…·ä½“çš„é”™è¯¯ä¿¡æ¯æ¥å‘Šè¯‰å‰ç«¯è°ƒç”¨è€…ã€

è¿™æ ·å­æˆ‘ä»¬çš„å‚æ•°æ ¡éªŒåŠŸèƒ½å°±å®Œæˆäº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿ

### æ¨¡å‹å‚æ•°æ ¡éªŒ

å¦‚æœä½ çš„é¡¹ç›®éœ€è¦å¼•å…¥`schema`æ¨¡å‹ï¼ˆä¾‹å¦‚ä½ æŠŠå®ƒå†™åˆ°çš„`swaggar`æ–‡æ¡£ä¸­ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨`ajv`è¿™ä¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥åŸºäº`schema`è¿›è¡Œæ¨¡å‹çš„æ ¡éªŒ

> å¦‚ä½•å°†æ¨¡å‹å†™å…¥åˆ°swaggaråç»­ä¼šä»‹ç»

```bash
pnpm i ajv
```

```javascript
// copy form https://ajv.js.org/
const Ajv = require("ajv")
const ajv = new Ajv()

// å®šä¹‰ä½ çš„æ¨¡å‹
// JSON Schema
const schema = {
  type: "object",
  properties: {
    foo: {type: "integer"},
    bar: {type: "string"}
  },
  // è¡¨ç¤ºå¿…é¡»å­˜åœ¨çš„å±æ€§
  required: ["foo"],
  // è¡¨ç¤ºä¸å…è®¸æœ‰schemaä¸­æœªå®šä¹‰çš„é¢å¤–å±æ€§
  additionalProperties: false
}

// æ¨¡æ‹Ÿè¦éªŒè¯çš„æ•°æ®å¯¹è±¡ï¼Œå®é™…ä¸Šåº”è¯¥æ˜¯ctx.request.body
const data = {foo: 1, bar: "abc"}
// éªŒè¯æ•°æ®
const valid = ajv.validate(schema, data)
// é”™è¯¯æ—¶æ‰“å°æ•°æ®ï¼Œä¼šè¯´æ˜é”™è¯¯é—®é¢˜
if (!valid) console.log(ajv.errors)
```

å¦‚æœæ¥å£æ¶‰åŠåˆ°æ¨¡å‹æ“ä½œï¼Œæ¨èè¯¥æ–¹æ³•è¿›è¡ŒéªŒè¯

æ‰©å±•å­¦ä¹ `AJV`ï¼Œè¯·å‰å¾€[ajv](https://ajv.js.org/)

## æ‰©å±•å·¥å…·å‡½æ•°

åœ¨æˆ‘ä»¬å¼€å‘å‰ç«¯é¡¹ç›®ä¸­ï¼Œæˆ‘å¸¸å¸¸ä¼šåœ¨`src`æ–‡ä»¶å¤¹ä¸­åˆ›å»ºç±»ä¼¼`utils`ï¼Œ`common/utils`ç­‰å‘½åçš„æ–‡ä»¶å¤¹æ¥å­˜æ”¾ä¸€äº›å¸¸ç”¨æˆ–è€…é€šç”¨å·¥å…·å‡½æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨ä¸šåŠ¡ä¸­å¼•ç”¨

è™½ç„¶åœ¨`egg.js`ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™æ ·å­å¹²ï¼Œä½†æ˜¯`egg.js`ä¸­ï¼Œæä¾›äº†`helper`æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ç³»åˆ—çš„å·¥å…·å‡½æ•°å†™å…¥åˆ°`app/extend/helper.js`ï¼Œä¹‹åæˆ‘ä»¬æ— è®ºåœ¨ä½•å¤„ï¼Œåªè¦æœ‰`ctx`å¯¹è±¡ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è°ƒç”¨åˆ°`helper`ä¸­çš„å·¥å…·å‡½æ•°

æ¯”å¦‚æˆ‘ä»¬å†™ä¸¤ä¸ªé€šç”¨çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ç”Ÿæˆå’ŒéªŒè¯`jwt`çš„æ–¹æ³•

> process.env æ˜¯nodejsçš„ç¯å¢ƒå˜é‡
>
> JWT_SECRETæ˜¯JWTå¯†é’¥
>
> JWT_EXPIRES_INæ˜¯JWTè¿‡æœŸæ—¶é—´
>
> è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡æ˜¯éœ€è¦åœ¨envæ–‡ä»¶ä¸­è‡ªå·±é…ç½®å®šä¹‰çš„ï¼Œåç»­ä¼šä»‹ç»


æˆ‘ä»¬éœ€è¦å®‰è£…ä¸‹`jsonwebtoken`è¿™ä¸ªåº“ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨`Node.js`å®ç°çš„`JWT`åº“

```javascript
// app/extend/helper.js
const jwt = require('jsonwebtoken');
module.exports = {
  // ç”Ÿæˆjwt
  generateToken(data) {
    return jwt.sign(data, process.env.JWT_SECRET, { expiresIn: process.env.JWT_EXPIRES_IN }); // ç”Ÿæˆtoken
  },
  // éªŒè¯jwt
  verifyToken(token) {
    return jwt.verify(token, process.env.JWT_SECRET); // éªŒè¯token
  }
}
```

> æ‰©å±•å­¦ä¹ `helper`è¯·å‰å¾€ [helper](https://www.eggjs.org/basics/extend#helper) 
>
> æ‰©å±•å­¦ä¹ `node-jsonwebtoken`è¯·å‰å¾€ [node-jsonwebtoken](https://github.com/auth0/node-jsonwebtoken) 

## ä¸­é—´ä»¶

ä¸­é—´ä»¶æ˜¯ä¸€ä¸ªå¾ˆæ ¸å¿ƒçš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥ä»‹å…¥æ¯ä¸€æ¬¡è¯·æ±‚ä¸­çš„æŸä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚åˆ¤æ–­ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæ²¡æœ‰ä¸­é—´ä»¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æ¯ä¸€ä¸ª`controller`ä¸­æ·»åŠ ä¸Šåˆ¤æ–­è¯­å¥ï¼Œè€Œæœ‰äº†ä¸­é—´ä»¶æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨è¯·æ±‚å‰åˆ¤æ–­ç”¨æˆ·å‘é€è¯·æ±‚æ—¶æ˜¯å¦æºå¸¦äº†`authentication`è¯·æ±‚å¤´

ä¸­é—´ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¹²å¾ˆå¤šäº‹æƒ…

æˆ‘ä»¬éœ€è¦åœ¨`egg.js`æ¡†æ¶ä¸­æŒ‡å®šçš„ç›®å½•ä¸‹åˆ›å»ºä¸­é—´ä»¶ï¼ˆ`app/middleware`ï¼‰

è¿™é‡Œä»¥æ ¡éªŒç”¨æˆ·ç™»å½•çŠ¶æ€çš„åœºæ™¯ä¸ºä¾‹

> è¿™é‡Œæä¸€ä¸‹ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ç°æœ‰çš„`egg-jwt`æ’ä»¶ï¼Œå› ä¸ºè¿™ä¸ªæ’ä»¶æ²¡æœ‰ç»´æŠ¤äº†ï¼Œè€Œä¸”ä¹‹å‰åœ¨ä½¿ç”¨è¿™ä¸ªæ’ä»¶çš„æ—¶å€™é‡åˆ°äº†é—®é¢˜ä¹Ÿæ— æ³•è§£å†³ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨äº†`jsonwebtoken`è¿™ä¸ªåº“

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨`middleware`ï¼Œæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª`auth.js`æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ª`auth`ä¸­é—´ä»¶

```javascript
// /app/middleware/auth.js
const jwt = require('jsonwebtoken');

module.exports = () => {
  return async function auth(ctx, next) {
    const token = ctx.get('Authorization'); // å‡è®¾tokenæ”¾åœ¨Authorization headerä¸­
    if (!token) {
      ctx.status = 401;
      ctx.body = {
        message: 'è¯·å…ˆç™»å½•ç”¨æˆ·',
      };
      return;
    }
    try {
      const decoded = jwt.verify(token.replace('Bearer ', ''), process.env.JWT_SECRET);
      ctx.state.user = decoded; // å°†è§£ç åçš„ç”¨æˆ·ä¿¡æ¯å­˜åˆ°ctx.stateä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
      await next();
    } catch (err) {
      // æ›´é€šç”¨çš„é”™è¯¯å¤„ç†ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´é”™è¯¯ç å’Œæ¶ˆæ¯
      ctx.status = 401;
      ctx.body = {
        message: 'è®¤è¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•',
      };
      return;
    }
  };
};
```

åœ¨å†™å®Œä¸­é—´ä»¶åï¼Œè¿™ä¸ªæ—¶å€™ä¸­é—´ä»¶å¹¶ä¸ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ³¨å†Œä½¿ç”¨å®ƒï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è·¯ç”±ï¼Œå…¨å±€æ³¨å†Œï¼Œè§„åˆ™åŒ¹é…çš„æ–¹å¼ä½¿ç”¨å®ƒï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨è·¯ç”±çš„æ–¹å¼æ¥æ³¨å†Œä¸€ä¸‹å®ƒ

### è·¯ç”±æ³¨å†Œä¸­é—´ä»¶
```javascript
// router.js
/**
 * @param {Egg.Application} app - egg application
 */
module.exports = app => {
  const { router, controller,middleware } = app;
  const apiPrefix = '/api';
  // è¿™é‡Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå‘Šè¯‰egg.jsè¯¥è·¯ç”±éœ€è¦å…ˆèµ°`auth`ä¸­é—´ä»¶
  router.resources('users', `${apiPrefix}/users`,middleware.auth(), controller.users);
};

```

### å¸¦å‚æ•°çš„ä¸­é—´ä»¶

ä¸­é—´ä»¶å…¶å®æ˜¯å¯ä»¥å¸¦å‚æ•°çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è·¯ç”±ä¸­ä¼ é€’å‚æ•°æˆ–è€…åœ¨`config`ä¸­ä¼ é€’ç»™ä¸­é—´ä»¶

```javascript
// è¿™é‡Œçš„optionsæŒ‡çš„æ˜¯å¤–éƒ¨ä¼ é€’è¿›æ¥çš„å‚æ•°
// è¿™é‡Œå‚æ•°å¯ä»¥æ˜¯å…¨å±€å‚æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯è·¯ç”±ä¸­ä¼ é€’è¿›æ¥çš„
module.exports = options => {
  return async function auth(ctx, next) {
    // æ¯”å¦‚åœ¨éªŒè¯ç”¨æˆ·æ—¶ï¼Œå¤šä¸€å±‚åˆ¤æ–­æ˜¯å¦ä¸ºè¶…çº§ç”¨æˆ·
    if(options.super){
      // åˆ¤æ–­è¯·æ±‚ç”¨æˆ·æ˜¯å¦ä¸ºè¶…çº§ç”¨æˆ·è®¿é—®
      // ä¸€äº›ä¸šåŠ¡é€»è¾‘
      await next();
    }else{
      // ä¸€äº›ä¸šåŠ¡é€»è¾‘
      await next();
    }
  }
}
```
#### é€šè¿‡è·¯ç”±ä¸­é—´ä»¶ä¼ é€’å‚æ•°çš„æ–¹å¼
```javascript
// router.js
const superAuth = app.middleware.auth({ super: true });
// åªèƒ½è¶…çº§ç”¨æˆ·è®¿é—®çš„è·¯ç”±
router.post('/api/admin/users/create', superAuth, controller.admin.users.create)
```
#### å…¨å±€ä¸­é—´ä»¶å‚æ•°ä¼ é€’
```javascript
// config/config.default.js
module.exports = {
  // å…¨å±€æ³¨å†Œï¼Œå…¨éƒ¨è·¯ç”±æ¥å£éƒ½éœ€è¦èµ°è¿™ä¸ªä¸­é—´ä»¶
  middleware: ['auth'],

  auth: {
    // æ‰€æœ‰çš„ç”¨æˆ·å¿…é¡»çš„è¶…çº§ç”¨æˆ·
    super:true
  },
};
```

### æ— æ•ˆè¯·æ±‚å¤„ç†

æˆ‘ä»¬å†æ¥å†™ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ˜¯å…³äº**è¯·æ±‚åœ°å€æœ‰è¯¯**çš„ä¸­é—´ä»¶ï¼Œå½“ç”¨æˆ·è¯·æ±‚åˆ°ä¸€ä¸ªæ— æ•ˆçš„`Api`åœ°å€æ—¶ï¼Œæˆ‘ä»¬ç»Ÿä¸€è¿”å›`404`çŠ¶æ€ç å’Œ`Not Found`

```javascript
module.exports = () => {
  return async function notFoundHandler(ctx, next) {
    await next();
    if (ctx.status === 404 && !ctx.body) {
      if (ctx.acceptJSON) {
        ctx.status = 404
        ctx.body = { error: 'Not Found' };
      } else {
        ctx.status = 404
        ctx.body = '<h1>Page Not Found</h1>';
      }
    }
  };
};
```
è¿™ä¸ªä¸­é—´ä»¶ï¼Œæˆ‘ä»¬é‡‡ç”¨å…¨å±€æ³¨å†Œçš„æ–¹å¼æ¥æ˜¯ä½¿ç”¨å®ƒ

è¿™é‡Œæˆ‘ä»¬åªéœ€è¦æŠŠä¸­é—´ä»¶çš„åå­—ä¼ é€’ç»™`config.middleware`çš„æ•°ç»„ä¸­å³å¯ï¼Œå› ä¸º`egg.js`å†…éƒ¨ä¼šè‡ªåŠ¨å¯»æ‰¾åˆ°è¿™ä¸ªä¸­é—´ä»¶

```javascript
// config/config.default.js
config.middleware = ['notfoundHandler'];
```

## é”™è¯¯å¤„ç†

### ä¸šåŠ¡é”™è¯¯å¤„ç†

è¿™ä¸€å—æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªä¸­é—´ä»¶æ¥å®ç°ä¸šåŠ¡ä»£ç çš„å¤„ç†

```javascript
// app/middleware/errorHandler.js
module.exports = () => {
  return async function errorHandler(ctx, next) {
    try {
      await next();
    } catch (err) {
      const { app } = ctx;
      // è®°å½•é”™è¯¯æ—¥å¿—ï¼Œæ–¹ä¾¿è¿½è¸ªé—®é¢˜
      app.emit('error', err, ctx);

      const status = err.status || 500;

      // åˆ¤æ–­è¿è¡Œç¯å¢ƒï¼Œå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œä¸è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
      const error = status === 500 && app.config.env === 'prod' ? 'Internal Server Error' : err.message;

      ctx.body = { error };
      ctx.status = status;
    }
  };
};
```

æŒ‚è½½ä¸­é—´ä»¶åˆ°å…¨å±€ä¸­ï¼Œä¹‹åä»£ç ä¸­é‡åˆ°çš„å¼‚å¸¸è¢«è¿™ä¸ªä¸­é—´ä»¶å¤„ç†

```javascript
// config/config.default.js
module.exports = {
  middleware: [ 'errorHandler' ],
};
```

### å…œåº•é”™è¯¯å¤„ç†

è™½ç„¶æˆ‘ä»¬å¯ä»¥åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨`try..catch`è¿›è¡Œæ•è·é”™è¯¯å¹¶å¤„ç†

ä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒæ— æ³•æ•è·ï¼Œä¾‹å¦‚åœ¨å›è°ƒå‡½æ•°ä¸­çš„é”™è¯¯ï¼Œå®ƒæ— æ³•æ­£å¸¸èµ°å‘`catch`ä»£ç å—

å¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹ä¸šåŠ¡è¿›è¡Œå…¨å±€é”™è¯¯å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`egg.js`æä¾›çš„`app.onerror`äº‹ä»¶

```javascript
// config/config.default.js
module.exports = {
  onerror: {
    all(err, ctx) {
      ctx.body = 'æœåŠ¡å™¨å‡ºé”™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
      ctx.status = 500;
    }
  }
};
```

> æ‰©å±•å­¦ä¹ è¯·å‰å¾€ [Middleware](https://www.eggjs.org/basics/middleware) å­¦ä¹ 

## Env ç¯å¢ƒå˜é‡

`egg.js`æœ¬èº«æä¾›äº†`app.config.env`çš„èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œå¹¶ä¸èƒ½æ»¡è¶³å¼€å‘éœ€æ±‚ï¼ˆè¿™é‡ŒæŒ‡æŸäº›å•ç‹¬çš„æ–‡ä»¶æ— æ³•è®¿é—®åˆ°`ctx`å¯¹è±¡ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°`dotenvx`è¿™ä¸ªåº“

> è¿™é‡Œï¼Œå¦‚æœæ‚¨çš„å¼€å‘ç¯å¢ƒNode.jsç‰ˆæœ¬æ˜¯ä½¿ç”¨çš„20ç‰ˆæœ¬ä»¥ä¸Šï¼Œå¯ä»¥ä¸å®‰è£…dotenvxï¼Œå› ä¸ºNode.jsæœ¬èº«è‡ªå¸¦çš„è¯»å–envçš„èƒ½åŠ›
>
> å…·ä½“è¯·é˜…è¯»[How to read environment variables from Node.js](https://nodejs.org/en/learn/command-line/how-to-read-environment-variables-from-nodejs)

å®‰è£…åï¼Œæˆ‘ä»¬å¦‚æœéœ€è¦å®šä¹‰ç¯å¢ƒå˜é‡çš„è¯ï¼Œå¯ä»¥åœ¨`env`æ–‡ä»¶ä¸­å¡«å†™å¯¹åº”çš„`key-value`

```bash
// .env
# JWT Config
JWT_SECRET=LxXJi6Rv9t3JPLci
JWT_EXPIRES_IN=7d
```
åœ¨ä»£ç ä¸­è·å–ç¯å¢ƒå˜é‡
```javascript
console.log(process.env.JWT_SECRET);
// LxXJi6Rv9t3JPLci
```

å¦‚æœä½ æƒ³è¦åŒºåˆ†ç¯å¢ƒæ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨`.env.development`ï¼Œ`.env.production`æ–‡ä»¶æ¥å®šä¹‰ç¯å¢ƒå˜é‡

å¯åŠ¨å‘½ä»¤å¦‚ä¸‹
```bash
# ç”Ÿäº§ç¯å¢ƒ
dotenvx run -f .env.production -- egg-scripts start --daemon --title=egg-server
# å¼€å‘ç¯å¢ƒ
dotenvx run -f .env.development -- egg-bin dev
```

> æ‰©å±•å­¦ä¹ è¯·å‰å¾€ [dotenvx](https://dotenvx.com/) å®˜ç½‘

## å¤šè·¯ç”±ç®¡ç†

è·¯ç”±ç®¡ç†æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µï¼Œå®ƒå†³å®šäº†æˆ‘ä»¬çš„`Api`çš„è®¿é—®åœ°å€ï¼Œä»¥åŠè·¯ç”±çš„åˆ†å‘

å‰é¢ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬çš„å¿«é€Ÿ`crud`æ¡ˆä¾‹å·²ç»å±•ç¤ºäº†è·¯ç”±çš„ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜ä¸å¤Ÿå…¨é¢ï¼Œåœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰å¾ˆå¤šçš„è·¯ç”±åœ°å€ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ°è·¯ç”±ç®¡ç†äº†

æˆ‘ä»¬å¯ä»¥å°†ä¸åŒæ¨¡å—çš„`Router`è·¯å¾„æ‹†åˆ†å‡ºæ¥ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å°†`store`æ¨¡å—å’Œ`admin`æ¨¡å—çš„è·¯ç”±æ‹†åˆ†å‡ºæ¥ï¼Œæœ€ç»ˆåœ¨`router`ä¸­å¼•å…¥ä½¿ç”¨

```javascript
// app/router.js
module.exports = (app) => {
  require('./router/store')(app);
  require('./router/admin')(app);
};
```
```javascript
// app/router/store.js
module.exports = (app) => {
  app.router.resources('store','/store/list', app.controller.store);
};
```
```javascript
// app/router/admin.js
module.exports = (app) => {
  app.router.resources('adminUser','/admin/user', app.controller.admin);
};
```

## é…ç½®Swaggaræ–‡æ¡£

åœ¨ä¸å‰ç«¯å¼€å‘æ—¶ï¼Œå¾€å¾€ç¦»ä¸å¼€ä¸€ä»½`API`æ¥å£æ–‡æ¡£ï¼Œå®ƒå¯ä»¥å¸®åŠ©å‰ç«¯å¼€å‘è€…æ›´å¥½çš„ä½¿ç”¨æˆ‘ä»¬çš„æ¥å£ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç¬¬ä¸‰æ–¹æ’ä»¶æ¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç”Ÿæˆæ–‡æ¡£

```bash
pnpm i swagger-egg
```

åœ¨`config/plugin.local.js`ä¸­æ³¨å†Œæ’ä»¶

> è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`local`ç¯å¢ƒï¼Œä¹Ÿå³æ˜¯åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸‹æ‰ä¼šç”Ÿæˆswaggaræ–‡æ¡£

```javascript
/** @type Egg.EggPlugin */
module.exports = {
  swaggerEgg: {
    enable: true,
    package: 'swagger-egg',
  }
}

```

åœ¨`config/config.local.js`æ–‡ä»¶ä¸­ï¼Œé…ç½®æ’ä»¶çš„ä¿¡æ¯

```javascript
// {app_root}/config/config.local.js
exports.swaggerEgg = {
  schema: {
    // ä½ çš„schemaæ–‡ä»¶å¤¹è·¯å¾„
    path: '/app/schema',
  },
  swagger: {
    info: {
      title: 'EggJsæ¨¡æ¿APIæ–‡æ¡£',
      description: 'EggJsæ¨¡æ¿APIæ–‡æ¡£',
      version: '1.0.0'
    },
    externalDocs: {
      url: 'https://swagger.io',
      description: 'Find more info here'
    },
    // æœåŠ¡åœ°å€
    host: '127.0.0.1:7001',
    schemes: ['http', 'https'],
    consumes: ['application/json'],
    produces: ['application/json'],
    // å®šä¹‰æ ‡ç­¾ï¼Œç”¨äºåˆ†ç±»
    tags: [
      { name: 'User', description: 'ç”¨æˆ·æ¨¡å—' },
      { name: 'Demo', description: 'Demoæ¨¡å—' }
    ],
    typescriptJsonSchema: false,
  }
};
```

æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ª`schema`ï¼Œå³æ•°æ®æ¨¡å‹ï¼Œå†™å…¥åˆ°é¡¹ç›®ä¸­

> å®ƒæ˜¯åŸºäº`JSON Schema`æ ‡å‡†ï¼Œä¸€ç§ç”¨äºæè¿°å’ŒéªŒè¯ JSON æ•°æ®æ ¼å¼çš„è§„èŒƒ
> æ‰©å±•äº†è§£å¯ä»¥è®¿é—®[json-schema](https://json-schema.org/)

```javascript
// æ³¨æ„è·¯å¾„
// app/schema/demo.js
const schema = {
  type: "object",
  properties: {
    foo: {type: "integer"},
    bar: {type: "string"}
  },
  // è¡¨ç¤ºå¿…é¡»å­˜åœ¨çš„å±æ€§
  required: ["foo"],
  // è¡¨ç¤ºä¸å…è®¸æœ‰schemaä¸­æœªå®šä¹‰çš„é¢å¤–å±æ€§
  additionalProperties: false
}
module.exports = schema
```

åœ¨æ§åˆ¶å™¨ä¸­ï¼Œé€šè¿‡æ³¨é‡Šçš„æ–¹å¼æ¥å®šä¹‰æ¥å£æ–‡æ¡£

è¿™é‡Œæˆ‘ä»¬å†™äº†ä¸€äº›ä¿¡æ¯ï¼Œåˆ†åˆ«ä»£è¡¨å‡½æ•°åç§°ï¼Œæ¥å£æè¿°ä¿¡æ¯ï¼Œæ¥å£ä¼ å…¥å‚æ•°ç±»å‹ä¿¡æ¯ï¼Œä»¥åŠè¿”å›å“åº”çš„æ¨¡å‹
```javascript
/**
  * #swagger-api
  * @function demo
  * @description #tags Demo
  * @description #parameters id path string true - parameter id
  * @description #responses 200 schema.demo - demoæ¨¡å‹
  * @summary æµ‹è¯•-è¿”å›demoæ¨¡å‹
  */
  async demo() {
    // å¿½ç•¥ä¸€äº›ä»£ç 
  }
```
æ­¤æ—¶æˆ‘ä»¬å¯ä»¥è·‘ä¸€ä¸‹æœåŠ¡ï¼Œå¹¶è®¿é—®`http://127.0.0.1:7001/public/index.html`ï¼Œå³å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšå®šä¹‰çš„æ¥å£æ–‡æ¡£äº†

![20240805123014](https://raw.githubusercontent.com/QC2168/note-img/main/20240805123014.png)

å¦‚æœæ‚¨è¿˜æƒ³é…ç½®æ›´å¤š`swagger-egg`ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥é˜…æ–‡æ¡£[JsonMa/swagger-egg](https://github.com/JsonMa/swagger-egg)

### ORM

å…¨ç§°`Object Relational Mapping`ï¼Œæ˜¯ä¸€ç§ä¸ºäº†è§£å†³é¢å‘å¯¹è±¡ä¸å…³ç³»æ•°æ®åº“å­˜åœ¨çš„äº’ä¸åŒ¹é…çš„ç°è±¡çš„æŠ€æœ¯

ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™å¾ˆå¤šé‡å¤çš„æ•°æ®åº“SQLè¯­å¥ï¼Œå¦‚æœä½¿ç”¨ORMæ–¹å¼è¿›è¡Œå¼€å‘ï¼Œæˆ‘ä»¬å¯ä»¥èŠ‚çœå¾ˆå¤šçš„é‡å¤è¯­å¥ï¼Œå¹¶ä¸”å¯ä»¥æ›´å¥½çš„è¿›è¡Œæ•°æ®æ¨¡å‹çš„ç®¡ç†

![20240805132247](https://raw.githubusercontent.com/QC2168/note-img/main/20240805132247.png)


æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`sequelize`æ¥ç®¡ç†æˆ‘ä»¬çš„æ•°æ®åº“ï¼Œå®ƒæä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚

`eggjs`å®˜æ–¹å·²ç»å°†`sequelize`å°è£…æˆäº†ä¸€ä¸ªæ’ä»¶ï¼Œæ›´æ–¹ä¾¿æˆ‘ä»¬å¼€å‘è€…è¿›è¡Œå¼€å‘è°ƒç”¨

è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯`mysql`æ•°æ®åº“ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…`mysql2`æ’ä»¶

> å¦‚æœä½ ä½¿ç”¨çš„æ˜¯å…¶ä»–æ•°æ®åº“ï¼Œè¯·è‡ªè¡Œå®‰è£…å¯¹åº”çš„æ’ä»¶

```bash
pnpm i egg-sequelize sequelize-cli mysql2
# pnpm i pg pg-hstore # PostgreSQL
```

åœ¨`plugin.js`å’Œ`config.default.js`ä¸­å¼•å…¥å®ƒï¼Œå¹¶é…ç½®

```javascript
// config/plugin.js
exports.sequelize = {
  enable: true,
  package: 'egg-sequelize'
}
```
```javascript
// config/config.default.js
exports.sequelize = {
  dialect: 'mysql',
  database: 'egg-starter',
  host: 'localhost',
  port: 3306,
  username: 'root',
  password: '',
};
```
è¿™é‡Œæ¨èæŠŠæ•°æ®åº“çš„é…ç½®æ”¾åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼Œè¿™æ ·æ–¹ä¾¿ç®¡ç†ï¼Œåç»­æ ¹æ®ä¸åŒçš„ç¯å¢ƒåœ¨`env`æ–‡ä»¶ä¸­è·å–å€¼å³å¯

> æ³¨æ„ï¼šæˆ‘å¹¶æ²¡æœ‰åˆ›å»ºä¸€ä¸ªconfig.prod.jsï¼Œæˆ‘æ•´ä¸ªé¡¹ç›®æ˜¯é€šè¿‡envæ–‡ä»¶è¿›è¡Œå˜é‡ç®¡ç†çš„

```javascript
config.sequelize = {
  dialect: process.env.DB_DIALECT,
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT, 10),
  database: process.env.DB_NAME,
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
};
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™å®šä¹‰æ¨¡å‹ï¼Œè¿™é‡Œæ˜¯æ¨¡å‹æŒ‡çš„æ˜¯æˆ‘ä»¬çš„æ•°æ®åº“è¡¨ç»“æ„

æˆ‘çš„åšæ³•æ˜¯é€šè¿‡sequelizeä¸­çš„migrationæ¥è¿›è¡Œæ¨¡å‹çš„ç®¡ç†

æˆ‘ä»¬éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå‘Šè¯‰`sequelize`ç”Ÿæˆä¸€ä¸ªè®°å½•æ–‡ä»¶

`--name`æŒ‡çš„æ˜¯æˆ‘ä»¬æœ¬æ¬¡è®°å½•çš„æ–‡ä»¶åç§°ï¼Œä¹Ÿæ–¹ä¾¿æˆ‘ä»¬åç»­æŸ¥è¯¢æ“ä½œ
```bash
sequelize migration:generate --name=init-users
```
å½“ä½ æ‰§è¡Œå®Œåï¼Œä½ ä¼šåœ¨ç»ˆç«¯ä¸­çœ‹åˆ°ä»¥ä¸‹å­—æ ·ï¼Œä»£è¡¨åˆ›å»ºæˆåŠŸ
```
PS E:\project\egg-starter> pnpm exec sequelize migration:generate --name=init-users

Sequelize CLI [Node: 20.15.0, CLI: 6.6.2, ORM: 6.37.3]

migrations folder at "E:\project\egg-starter\database\migrations" already exists.
New migration was created at E:\project\egg-starter\database\migrations\20240805055333-init-users.js .
```

æ‰“å¼€ç”Ÿæˆåçš„æ–‡ä»¶ï¼Œä½ ä¼šçœ‹åˆ°æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯`up`å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯`down`å‡½æ•°ï¼Œåˆ†åˆ«ä»£è¡¨åˆ›å»ºå’Œåˆ é™¤æ•°æ®åº“è¡¨çš„æ“ä½œ

åœ¨è¿™ä¸¤ä¸ªå‡½æ•°ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨`queryInterface`å±æ€§è¿›è¡Œæ•°æ®åº“çš„æ“ä½œï¼Œæ¯”å¦‚åˆ›å»ºè¡¨

æˆ‘ä»¬å¡«å†™ä¸€äº›ç”¨æˆ·è¡¨çš„å±æ€§

```javascript
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface, Sequelize) {
    // ä½¿ç”¨ queryInterface åˆ›å»ºä¸€ä¸ªæ–°è¡¨
    const RoleEnum = Sequelize.ENUM('admin', 'user');
    await queryInterface.createTable('users', {
      // è¡¨çš„å­—æ®µå®šä¹‰
      id: {
        type: Sequelize.INTEGER,
        primaryKey: true,
        autoIncrement: true,
        allowNull: false,
      },
      avatar: Sequelize.STRING(255),
      role: RoleEnum,
      username: Sequelize.STRING(30),
      mobile: Sequelize.STRING(11),
      email: Sequelize.STRING(30),
      password: Sequelize.STRING(255),
      last_logied: {
        type: Sequelize.DATE,
        defaultValue: Sequelize.NOW,
      },
      created_at: {
        type: Sequelize.DATE,
        defaultValue: Sequelize.NOW,
      },
      updated_at: {
        type: Sequelize.DATE,
        defaultValue: Sequelize.NOW,
      },
    });
  },

  async down(queryInterface, Sequelize) {
    // ä½¿ç”¨ queryInterface åˆ é™¤è¡¨
    await queryInterface.dropTable('users');
  }
};
```

æˆ‘ä»¬åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª`Users`è¡¨ï¼ŒåŒ…å«`id`ã€`username`ã€`email`ã€`password`ã€`createdAt`ã€`updatedAt`äº”ä¸ªå­—æ®µ

è¿™é‡Œé¢çš„æ¯ä¸ªå­—æ®µæˆ‘ä»¬éƒ½é…ç½®ä¸€äº›å±æ€§ï¼Œä¾‹å¦‚`id`å­—æ®µï¼Œæˆ‘ä»¬è®¾ç½®äº†`primaryKey`å±æ€§ï¼Œä»£è¡¨è¿™ä¸ªå­—æ®µæ˜¯ä¸»é”®ï¼Œ`autoIncrement`å±æ€§ï¼Œä»£è¡¨è¿™ä¸ªå­—æ®µæ˜¯è‡ªå¢çš„ï¼Œ`allowNull`å±æ€§ï¼Œä»£è¡¨è¿™ä¸ªå­—æ®µå¯ä»¥ä¸ºç©ºï¼Œ`unique`å±æ€§ï¼Œä»£è¡¨è¿™ä¸ªå­—æ®µå¿…é¡»å”¯ä¸€

å¦‚æœä½ æƒ³è¦äº†è§£æ›´å¤šçš„å±æ€§é…ç½®ï¼Œå¯ä»¥æŸ¥é˜…[sequelizeæ–‡æ¡£](https://sequelize.org/docs/v6/core-concepts/model-basics//)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è·‘ä¸€ä¸‹è¿™ä¸ª`migration`æ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```
pnpm exec sequelize db:migrate
```
æ¥ä¸‹æ¥ï¼Œå†æŸ¥çœ‹æ•°æ®åº“ï¼Œå°±ä¼šçœ‹åˆ°æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„`Users`è¡¨äº†
![20240805140157](https://raw.githubusercontent.com/QC2168/note-img/main/20240805140157.png)
![20240806105422](https://raw.githubusercontent.com/QC2168/note-img/main/20240806105422.png)

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çš„ä»£ç è¿˜ä¸èƒ½ç›´æ¥å’Œæ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰æ¨¡å‹

æˆ‘ä»¬éœ€è¦åœ¨`app/model`ä¸­åˆ›å»ºä¸€ä¸ª`Users.js`æ¨¡å‹

> æ³¨æ„ï¼Œåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™è¡¨å­—æ®µæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯`snake`å†™æ³•ï¼Œä½†æ¨¡å‹é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯`camel`å†™æ³•
>
> å½“æˆ‘ä»¬åœ¨è°ƒç”¨`sequelize`çš„æ–¹æ³•æ—¶ï¼Œæ¨¡å‹ä¼šå°†å­—æ®µ`camel`è½¬ä¸º`snake`å†™æ³•
```javascript
'use strict';

module.exports = app => {
  const { STRING, INTEGER, DATE, NOW, ENUM } = app.Sequelize;
  const RoleEnum = ENUM('admin', 'user');
  const Users = app.model.define('Users', {
    id: {
      type: INTEGER,
      primaryKey: true,
      autoIncrement: true,
      allowNull: false,
    },
    avatar: STRING(255),
    role: RoleEnum,
    username: STRING(30),
    mobile: STRING(11),
    email: STRING(30),
    password: STRING(255),
    lastLogied: {
      type: DATE,
      defaultValue: NOW,
    },
    createdAt: {
      type: DATE,
      defaultValue: NOW,
    },
    updatedAt: {
      type: DATE,
      defaultValue: NOW,
    },
  });

  return Users;
};
```

è¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª`Users`æ¨¡å‹ï¼Œé‡Œé¢åŒ…å«äº†æˆ‘ä»¬åˆšåˆšå®šä¹‰çš„`Users`è¡¨çš„å­—æ®µ

> å¤§å®¶æœ‰æ²¡æœ‰å‘ç°ï¼Œæ¨¡å‹é‡Œé¢çš„å±æ€§å’Œä¹‹å‰æˆ‘ä»¬å†™åœ¨init-usersæ–‡ä»¶ä¸­çš„å±æ€§æ˜¯ä¸€æ ·çš„
> æˆ‘ç°åœ¨æ˜¯é€šè¿‡copyçš„æ–¹å¼å°†å­—æ®µæ‹·è´åˆ°modelæ–‡ä»¶ä¸­ï¼Œä¸çŸ¥é“æ˜¯å¦æœ‰æ›´å¥½çš„æ–¹å¼ï¼Œå†æ›´æ–°æ•°æ®åº“æ—¶ç›´æ¥æ›´æ–°æ¨¡å‹çš„æ–¹å¼ï¼Ÿ
>
> sequelizeæ˜¯æœ‰æä¾›äº†`sync`æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯é€šè¿‡æ¨¡å‹åŒæ­¥åˆ°æ•°æ®åº“ç»“æ„ï¼Œä¸å¥½è¿½è¸ªå˜åŒ–è®°å½•ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨è¿™ä¸ªæ–¹æ³•äº†ï¼Œè€Œæ˜¯ä½¿ç”¨migrationçš„æ–¹å¼

æ¥ä¸‹æ¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹Userè¡¨è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`app.model.Users`è¿›è¡Œæ“ä½œ

### åˆ›å»ºç”¨æˆ·

è¿™é‡Œä¸¾ä¸€ä¸ªåˆ›å»ºç”¨æˆ·çš„ä¾‹å­ï¼Œæ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨`sequelize`è¿›è¡Œæ•°æ®åº“æ“ä½œ

åœ¨è·¯ç”±è¡¨ä¸­æ·»åŠ ç”¨æˆ·æ¨¡å—è¯·æ±‚è®°å½•

```javascript
// app/router.js
router.resources('users','/users', controller.users);
```
åœ¨æ§åˆ¶å™¨ä¸­æ·»åŠ åˆ›å»ºç”¨æˆ·çš„æ–¹æ³•
```javascript
// app/controller/user.js
const Controller = require('egg').Controller;
class UserController extends Controller {
  async create() {
    const { ctx } = this;
    ctx.model.Users.create({
      username:'_island',
      email:'example@example.com',
      password:'h9nUQ92B'
    });
    ctx.body = {
      message:'åˆ›å»ºæˆåŠŸ'
    };
  }
}
module.exports = UserController;
```

æ¥ç€ï¼Œæˆ‘ä»¬è°ƒç”¨ä»¥ä¸‹å®ƒï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªç”¨æˆ·

![20240805150059](https://raw.githubusercontent.com/QC2168/note-img/main/20240805150059.png)



é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å¯¹æ–°å¢æ•°æ®çš„æ“ä½œæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œé‚£ä¹ˆå¦‚ä½•å¯¹æ•°æ®è¿›è¡ŒæŸ¥è¯¢ï¼Œä¿®æ”¹æ•°æ®ï¼Œåˆ é™¤æ•°æ®å‘¢ï¼Ÿ

å…¶å®ä¹Ÿå¾ˆç®€å•

### æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
```javascript
const Controller = require('egg').Controller;

class UsersController extends Controller {
  async findAll() {
    const users = await this.ctx.model.User.findAll();
    this.ctx.body = users;
  }
}

module.exports = UsersController;
```
### æŸ¥è¯¢ç‰¹å®šæ¡ä»¶çš„ç”¨æˆ·
```javascript
class UsersController extends Controller {
  // å¿½ç•¥å…¶ä»–ä»£ç 
  async findByUsername() {
    const user = await this.ctx.model.User.findOne({
      where: {
        username: '_island_',
      },
    });
    this.ctx.body = user;
  }
}
```
### ä¿®æ”¹ç”¨æˆ·
```javascript
const Controller = require('egg').Controller;

class UsersController extends Controller {
  // å¿½ç•¥å…¶ä»–ä»£ç 
  // ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
  async updateUser() {
    const { ctx } = this;
    const userId = ctx.params.id; // è·å–ç”¨æˆ·ID
    const updates = {
      username: ctx.request.body.username,
      email: ctx.request.body.email,
    };

    const [affectedCount] = await ctx.model.User.update(updates, {
      where: { id: userId },
    });

    if (affectedCount === 0) {
      ctx.status = 404;
      ctx.body = { message: 'ç”¨æˆ·æœªæ‰¾åˆ°' };
    } else {
      ctx.body = { message: 'ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ' };
    }
  }
}

module.exports = UserController;
```
### åˆ é™¤ç”¨æˆ·
```javascript
class UsersController extends Controller {
  // å¿½ç•¥å…¶ä»–ä»£ç 
  // åˆ é™¤ç”¨æˆ·
  async deleteUser() {
    const { ctx } = this;
    const id = ctx.params.id; // è·å–ç”¨æˆ·ID

    const result = await ctx.model.User.destroy({
      where: { id },
    });

    if (result === 0) {
      ctx.status = 404;
      ctx.body = { message: 'ç”¨æˆ·æœªæ‰¾åˆ°' };
    } else {
      ctx.body = { message: 'ç”¨æˆ·åˆ é™¤æˆåŠŸ' };
    }
  }
}
```

è¿™é‡Œç»™å¤§å®¶ç®€å•å±•ç¤ºäº†`CRUD`æ“ä½œï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ ¹æ®éœ€æ±‚è¿›è¡Œæ‰©å±•

å…³äºæ›´å¤šæ•°æ®åº“æ“ä½œï¼Œè¯·ç§»æ­¥[sequelizeæ–‡æ¡£](https://sequelize.org/docs/v6/core-concepts/model-querying-basics/)

### æ‰©å±•è¡¥å……

è¿˜è®°å¾—æˆ‘ä»¬ä¸Šé¢é…ç½®äº†`swaggar`å—ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™ä¸€ä¸ª`JSON schema`æ¥æè¿°æ¨¡å‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¨¡å‹æ¸²æŸ“`swagger`æ–‡æ¡£ä¸­çš„ç±»å‹äº†

æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­åˆ›å»º`app/schema/definitions/users.js`ï¼Œè¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹

```javascript
'use strict';

module.exports = {
  type: 'object',
  properties: {
    id: {
      type: 'integer',
    },
    avatar: {
      type: 'string',
      maxLength: 255,
    },
    role: {
      type: 'string',
      enum: ['admin', 'user'],
    },
    username: {
      type: 'string',
      maxLength: 30,
    },
    mobile: {
      type: 'string',
      maxLength: 11,
    },
    email: {
      type: 'string',
      maxLength: 30,
    },
    password: {
      type: 'string',
      maxLength: 255,
    },
    last_login: {
      type: 'string',
      format: 'string',
    },
    created_at: {
      type: 'string',
      format: 'string',
    },
    updated_at: {
      type: 'string',
      format: 'string',
    },
  },
  required: ['id', 'username', 'email', 'password', 'role'], // ç¡®å®šå“ªäº›å­—æ®µæ˜¯å¿…å¡«çš„
  // è¡¨ç¤ºä¸å…è®¸æœ‰ schema ä¸­æœªå®šä¹‰çš„é¢å¤–å±æ€§
  additionalProperties: false,
};

```


## æœ€å

æ„Ÿè°¢å¤§å®¶çš„é˜…è¯»å­¦ä¹ ï¼Œå¦‚æœå¤§å®¶å–œæ¬¢ï¼Œè¯·ç‚¹ä¸ª`star`ï¼Œè°¢è°¢

é™„ä¸Šæ¨¡æ¿åœ°å€: [https://github.com/QC2168/egg-starter](https://github.com/QC2168/egg-starter)


è¯¥æ¨¡æ¿è¿˜æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„æ¨¡æ¿ï¼Œåªæ˜¯é›†æˆäº†ä¸€äº›æœ€åŸºç¡€çš„å¸¸ç”¨åŠŸèƒ½ï¼Œåƒç”¨æˆ·æ¨¡å—ä¹‹ç±»çš„åŠŸèƒ½åç»­å¯èƒ½ä¼šæ·»åŠ ä¸Šå»ï¼Œå¦‚æœå¤§å®¶æœ‰ä»€ä¹ˆå»ºè®®å¯ä»¥åœ¨è¯„è®ºåŒºæˆ–`issues`ä¸­æå‡ºï¼Œæ¬¢è¿å¤§å®¶æå‡ºå®è´µæ„è§ï¼Œå…±åŒè¿›æ­¥

