## TCP

### 为什么需要三次握手

**通俗一点来讲：**

第一次握手是验证客户端可以正常发送信息

第二次握手是验证服务器端可以发送信息

第三次是客户端向服务器发送信息，确保双方可以正常通讯

目前是为了确定双方可以正常的接收信息和发送信息，避免其中一方出现了问题


**其实不止是为了确定双方是否可以正常通讯**

还可以利用数据包的选项来传输特殊信息，交换初始序列号ISN

1. 客户端发送一个SYN（SYN=1），和seq指定客户端的初始序列号seq=x（此时客户端处于synSend状态）
2. 服务器端在接收到SYN之后，也发送一个自己SYN（SYN=1），并指定一个自己的初始序列号seq=y，同时会将客户端的SYN+1作为ACK回传，表示已经收到客户端的信息了（服务器进入synReced）
3. 客户端收到服务器响应的SYN后，把服务器的SYN码+1作为ACK和seq=x+1回传给服务器端，表示收到服务器的SYN了，期望下一次收到的数据是seq=y+1
4. 当服务器接收了ACK之后，双方都进入established状态，创建TCP链接

### ISN是固定的么

ISN是客户端和服务器端交互数据比较重要的功能之一，用户让对方知道接下来要接收数据时如何按序列号组织数据

ISN不是固定的，是自动选择的，每个连接都有不同的ISN

如果是固定的值，很容易被攻击者猜出来后续的确认码

> 确定双方的是ACK码

### 为什么握手不能是两次

如果只有两次握手，只能确定客户端有发送能力，服务器则有接收能力

需要有第三次握手，才能确保服务器端有发送能力和客户端有接收能力。

### 三次握手的时候可以携带数据吗

第1，2次绝不能携带数据，因为如果有人攻击服务器的话，服务器在接收数据的时候会花费更多时间来接收这些报文

第3次可以携带数据，因为双方都确定了发送、接收能力

### 洪泛攻击

SYN攻击指的是客户端在短时间内，伪造大量不存在的IP地址，向服务器发送SYN包

服务器收到之后，会回复确认包并等待客户端响应，但由于IP是不存在的，服务器会进行重发直到超时

这些伪造的SYN包会占用半连接队列，导致正常的SYN请求因为队列满而被移除，导致网络堵塞，系统瘫痪


### 为什么需要四次挥手

因为TCP都是双向（一发一收）的，必须通过四次数据传输才能让双方完全停止数据发送。